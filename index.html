<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>生命数字测算系统（最终版）</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1) }
        .input-group { margin: 15px 0 }
        label { display: inline-block; width: 120px; font-weight: bold }
        input[type="date"], input[type="text"] { padding: 8px; width: 200px }
        table { width: 100%; border-collapse: collapse; margin: 20px 0 }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center }
        th { background: #4CAF50; color: white }
        .highlight { background: #ffeb3b !important }
        button { padding: 10px 25px; margin: 10px 5px; background: #2196F3;
                  color: white; border: none; border-radius: 5px; cursor: pointer }
        button:hover { background: #1976D2 }
        .error { color: red; font-weight: bold; margin-top: 10px }
        .section-title { color: #2c3e50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-top: 20px }
    </style>
</head>
<body>
    <!-- 浏览器兼容性提示 -->
    <!--[if lte IE 11]>
        <p style="color: red;">您的浏览器版本过旧，部分功能可能无法正常使用，建议升级浏览器或使用 Chrome/Firefox 访问！</p>
    <![endif]-->

    <div class="container">
        <h2 class="section-title">生命数字测算系统</h2>

        <div class="input-group">
            <label>出生日期:</label>
            <input type="date" id="birthdate" required>
        </div>

        <div class="input-group">
            <label>姓名:</label>
            <input type="text" id="name" placeholder="请输入中文姓名" required>
        </div>

        <div class="action-buttons">
            <button onclick="calculate()">开始测算</button>
            <button onclick="exportExcel()">下载Excel</button>
            <button onclick="screenshot()">保存截图</button>
        </div>

        <div id="result"></div>
        <div id="error-message" class="error"></div>
    </div>

    <!-- 外部库加载 -->
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.14.0/dist/index.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // 检查外部库加载状态
        if (typeof pinyinPro === 'undefined') {
            document.getElementById('error-message').textContent = "姓名转换功能依赖库加载失败，请稍后重试！";
        }
        if (typeof XLSX === 'undefined') {
            document.getElementById('error-message').textContent += " Excel导出功能依赖库加载失败，请稍后重试！";
        }
        if (typeof html2canvas === 'undefined') {
            document.getElementById('error-message').textContent += " 截图功能依赖库加载失败，请稍后重试！";
        }

        // 核心计算函数
        function sumDigits(num) {
            while (num >= 10) {
                num = num.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
            }
            return num;
        }

        function getFullSum(num) {
            let process = [num];
            while (num >= 10) {
                num = num.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
                process.push(num);
            }
            return process.join('/');
        }

        function calculatePhases(m, d, y, lifePath) {
            const phase1End = 36 - lifePath;
            return [
                {
                    阶段: "第一阶段",
                    年份: `0-${phase1End}`,
                    高峰: sumDigits(m + d),
                    挑战: sumDigits(Math.abs(m - d))
                },
                {
                    阶段: "第二阶段",
                    年份: `${phase1End + 1}-${phase1End + 7}`,
                    高峰: sumDigits(d + y),
                    挑战: sumDigits(Math.abs(d - y))
                },
                {
                    阶段: "第三阶段",
                    年份: `${phase1End + 8}-${phase1End + 15}`,
                    高峰: sumDigits(sumDigits(m + d) + sumDigits(d + y)),
                    挑战: sumDigits(Math.abs(sumDigits(m - d) - sumDigits(d - y)))
                },
                {
                    阶段: "第四阶段",
                    年份: `${phase1End + 16}+`,
                    高峰: sumDigits(m + y),
                    挑战: sumDigits(Math.abs(m - y))
                }
            ];
        }

        function analyzeName(name) {
            try {
                const pinyin = pinyinPro.pinyin(name, { toneType: 'none' }).replace(/\s+/g, '');
                const numMap = { A:1, B:2, C:3, D:4, E:5, F:6, G:7, H:8, I:9, J:1, K:2, L:3, M:4, N:5, O:6, P:7, Q:8, R:9,
                                 S:1, T:2, U:3, V:4, W:5, X:6, Y:7, Z:8 };

                // 表现数字计算
                const numbers = pinyin.toUpperCase().split('').map(c => numMap[c] || 0);
                const sumTotal = numbers.reduce((a, b) => a + b, 0);
                const 表现数字 = getFullSum(sumTotal);

                // 内驱数字
                const vowels = pinyin.toUpperCase().split('').filter(c => ['A', 'E', 'I', 'O', 'U'].includes(c));
                const 内驱部分 = vowels.map(c => numMap[c] || 0).reduce((a, b) => a + b, 0);
                const 内驱数字 = getFullSum(内驱部分);

                // 个特数字
                const 个特部分 = Math.abs(sumTotal - 内驱部分);
                const 个特数字 = getFullSum(个特部分);

                // 身体、思维、情绪、直觉数字
                const countMap = { 4:0, 5:0, 1:0, 8:0, 2:0, 3:0, 6:0, 7:0, 9:0 };
                numbers.forEach(n => { if (countMap[n] !== undefined) countMap[n]++ });
                const 身体数字 = countMap[4] + countMap[5];
                const 思维数字 = countMap[1] + countMap[8];
                const 情绪数字 = countMap[2] + countMap[3] + countMap[6];
                const 直觉数字 = countMap[7] + countMap[9];

                return {
                    全拼: pinyin,
                    表现数字,
                    内驱数字,
                    个特数字,
                    身体数字,
                    思维数字,
                    情绪数字,
                    直觉数字
                };
            } catch (error) {
                throw new Error("姓名转换失败，请检查输入是否为有效中文姓名！");
            }
        }

        // 界面交互函数
        function calculate() {
            const birthdate = document.getElementById('birthdate').value;
            const name = document.getElementById('name').value.trim();
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '';

            if (!birthdate) {
                errorDiv.textContent = "错误：请选择出生日期！";
                return;
            }

            if (!name || !/^[\u4e00-\u9fa5]{2,4}$/.test(name)) {
                errorDiv.textContent = "错误：姓名必须为2-4个中文字符！";
                return;
            }

            try {
                const [y, m, d] = birthdate.split('-').map(Number);
                const yearSum = sumDigits(y + m + d);
                const lifePath = sumDigits(yearSum);
                const nameData = analyzeName(name);
                const phases = calculatePhases(sumDigits(m), sumDigits(d), sumDigits(y), lifePath);
                const currentYear = new Date().getFullYear();
                const yearDigitSum = sumDigits(currentYear.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0));
                const 流年数字 = sumDigits(yearDigitSum + sumDigits(nameData.表现数字.split('/')[0]));

                // 构建结果表格
                const resultHTML = `
                    <h3 class="section-title">基础信息</h3>
                    <table>
                        <tr><th>项目</th><th>数值</th></tr>
                        <tr><td>生命道路数字</td><td>${lifePath}</td></tr>
                        <tr><td>制约数字</td><td>${sumDigits(nameData.表现数字.split('/')[0])}</td></tr>
                        <tr><td>流年数字</td><td>${流年数字}</td></tr>
                    </table>

                    <h3 class="section-title">姓名分析</h3>
                    <table>
                        <tr><th>类型</th><th>过程</th><th>结果</th></tr>
                        <tr><td>表现数字</td><td>${nameData.表现数字}</td><td>${sumDigits(nameData.表现数字.split('/').pop())}</td></tr>
                        <tr><td>内驱数字</td><td>${nameData.内驱数字}</td><td>${sumDigits(nameData.内驱数字.split('/').pop())}</td></tr>
                        <tr><td>个特数字</td><td>${nameData.个特数字}</td><td>${sumDigits(nameData.个特数字.split('/').pop())}</td></tr>
                        <tr><td>身体数字</td><td>${nameData.身体数字}</td><td>${nameData.身体数字}</td></tr>
                        <tr><td>思维数字</td><td>${nameData.思维数字}</td><td>${nameData.思维数字}</td></tr>
                        <tr><td>情绪数字</td><td>${nameData.情绪数字}</td><td>${nameData.情绪数字}</td></tr>
                        <tr><td>直觉数字</td><td>${nameData.直觉数字}</td><td>${nameData.直觉数字}</td></tr>
                    </table>

                    <h3 class="section-title">人生阶段</h3>
                    <table>
                        <tr><th>阶段</th><th>年份</th><th>高峰数字</th><th>挑战数字</th></tr>
                        ${phases.map(p => `
                            <tr>
                                <td>${p.阶段}</td>
                                <td>${p.年份}</td>
                                <td>${p.高峰}</td>
                                <td>${p.挑战}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;

                document.getElementById('result').innerHTML = resultHTML;
                highlightNumbers(流年数字);
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        function highlightNumbers(target) {
            document.querySelectorAll('td').forEach(td => {
                const num = parseInt(td.textContent);
                if (!isNaN(num) && num === target) {
                    td.classList.add('highlight');
                }
            });
        }

        function exportExcel() {
            try {
                const tables = document.querySelectorAll('table');
                if (tables.length === 0) {
                    throw new Error("请先生成测算结果！");
                }
                
                const wb = XLSX.utils.book_new();
                tables.forEach((table, index) => {
                    const ws = XLSX.utils.table_to_sheet(table);
                    XLSX.utils.book_append_sheet(wb, ws, `表格${index + 1}`);
                });
                
                XLSX.writeFile(wb, encodeURIComponent('生命数字报告.xlsx'), { bookType: 'xlsx' });
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
            }
        }

        function screenshot() {
            try {
                const container = document.querySelector('.container');
                if (!container) {
                    throw new Error("未找到测算内容，请先生成结果！");
                }
                
                html2canvas(container).then(canvas => {
                    canvas.toBlob(blob => {
                        const link = document.createElement('a');
                        link.download = '生命数字报告.png';
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(link.href); // 释放内存
                    });
                });
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
            }
        }
    </script>
</body>
</html>
